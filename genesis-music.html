<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="./lib/web3.min.js"></script>
<script src="http://code.jquery.com/jquery-latest.js "></script>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
 <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">

<body class="container">
    <div class="row">
      <h1>GEN MUSIC PLATFORM</h1>
      <div>
        <span>
          저작권자 이름 :
          <input  type="text" id="singerName"/>
          <button type="button" name="button" id="btnNewAccount" class="btn btn-primary">저작권자 지갑 생성</button>
        </span>
        <span style="display: inline-block; float: right">
          저작권자 :
          <select id="singerList">
          </select>
          음원 제목 :
          <input type='text' id="musicTitle"/>
          <button type="button" name="button" id="addMusic" class="btn btn-primary">음원 등록</button>
        </span>
      </div>
      <div class="table-responsive" style="margin-top: 10px">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>TITLE</th>
              <th>NAME</th>
              <th>PRICE</th>
              <th>PLAY</th>
            </tr>
          </thead>
          <tbody id="dataBody">
            <tr>
              <td>보이지 않는 사랑</td>
              <td>신승훈</td>
              <td>500원</td>
              <td>
                  <select class="userList">
                  </select>
                  <button type="button" name="button" id='btnPlay' class="btn btn-primary">play</button>
              </td>
            </tr>
            <tr>
              <td>잘못된 만남</td>
              <td>김건모</td>
              <td>500원</td>
              <td>
                  <select class="userList">
                  </select>
                  <button type="button" name="button" id='btnPlay' class="btn btn-primary">play</button>
              </td>
            </tr>
            <tr>
              <td>영원한 사랑</td>
              <td>핑클</td>
              <td>500원</td>
              <td>
                  <select class="userList">
                  </select>
                  <button type="button" name="button" id='btnPlay' class="btn btn-primary">play</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
</body>

<script type="text/javascript">
  // ico html 디자인에 google font와 w3 css를 사용했습니다.
var Web3 = require('web3');
var web3 = new Web3();
web3.setProvider(new web3.providers.HttpProvider("http://192.168.0.103:8545"));

var singerContractAddress = '0xb70ea6dbab3e292d18188510c0750dbbfe0ab299';
var singerContract = web3.eth.contract([
	{
		"constant": false,
		"inputs": [
			{
				"name": "_singer",
				"type": "address"
			},
			{
				"name": "_singerName",
				"type": "string"
			}
		],
		"name": "addSinger",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_singer",
				"type": "address"
			}
		],
		"name": "checkSinger",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_singer",
				"type": "address"
			}
		],
		"name": "getSingerName",
		"outputs": [
			{
				"name": "singerName",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]).at(singerContractAddress);

var musicContractAddress = '0x16630fd8da7d52c3477523242d40432187bdd078';
var musicContract = web3.eth.contract([
	{
		"constant": false,
		"inputs": [
			{
				"name": "_name",
				"type": "string"
			}
		],
		"name": "addMusic",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "singer",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "coin",
				"type": "uint256"
			}
		],
		"name": "play",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "singer",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "musicNumber",
				"type": "uint256"
			}
		],
		"name": "addedMusic",
		"type": "event"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_musicNumber",
				"type": "uint256"
			}
		],
		"name": "playMusic",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getLastMusicNumber",
		"outputs": [
			{
				"name": "lastMusicNumber",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_musicNumber",
				"type": "uint256"
			}
		],
		"name": "getMusicDetailInfo",
		"outputs": [
			{
				"name": "name",
				"type": "string"
			},
			{
				"name": "singer",
				"type": "address"
			},
			{
				"name": "price",
				"type": "uint256"
			},
			{
				"name": "coin",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_musicNumber",
				"type": "uint256"
			}
		],
		"name": "getMusicInfo",
		"outputs": [
			{
				"name": "name",
				"type": "string"
			},
			{
				"name": "singer",
				"type": "address"
			},
			{
				"name": "price",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]).at(musicContractAddress);

$(document).ready(function(){

  var newAccount;
  var singerArr = []
  var singerAddArr = []
  web3.eth.defaultAccount = web3.eth.accounts[0]

  // 음원 목록을 보여준다.
  let redirect = () => {
    var lastMusicNumber = musicContract.getLastMusicNumber()
    console.log("lastMusicNumber", lastMusicNumber.toNumber())
  }

  redirect()

  //관리자 계정을 생성한다.
  $('#btnNewAccount').on('click', function(){

    newAccount = web3.personal.newAccount('test')
    web3.personal.unlockAccount(newAccount, 'test', 0)

    //contract 의 저작권자 계정 함수 실행
    singerContract.addSinger(newAccount, $('#singerName').val())

  })

  //저작권자 목록을 가져온다.
  let singerList = () => {
    var accounts = web3.eth.accounts

    var acc =''
    singerArr = []
    singerAddArr = []

    accounts.map(function(item){
      acc = singerContract.getSingerName(item)
      if(acc){
       singerArr.push(acc)
       singerAddArr.push(item)
      }
    })

    var list = ''
    var singerNm = ''

    singerArr.map(function(item, i){
      list += "<option value='"+singerAddArr[i]+"'>"+item+"</option>"
    })
    $('#singerList').html(list)
  }

  //전체 목록을 가져온다.
  let userList = () => {
    var accounts = web3.eth.accounts
    var list = ''
    accounts.map(function(item){
      list += "<option value='"+item+"'>"+item+"</option>"
    })
    $('.userList').html(list)
  }

  singerList()
  userList()

  //음원 등록 버튼 클릭 시
  $('#addMusic').on('click', function(){

    //select box의 저작권자 계정과 title를 참조하여 contract의 함수 호출

    console.log($("#singerList option:selected").val())
    console.log($('#musicTitle').val())
    //
    web3.eth.defaultAccount = $("#singerList option:selected").val()
    //
    var a = musicContract.addMusic($('#musicTitle').val(), {from: $("#singerList option:selected").val(), gas: 200000})

    console.log(a)

    // web3.eth.defaultAccount = web3.eth.accounts[0]
  })

  //play 버튼 클릭 시
  $('#btnPlay').on('click', function(){
    //select box의 사용자 계정과 해당 play버튼과 같은 열의 저작권자의 계정을 참조하여 contract의 transfer 실행

  })


})

</script>

</html>
